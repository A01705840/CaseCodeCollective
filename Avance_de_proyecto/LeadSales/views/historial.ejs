<%- include('includes/head.ejs', {username: username}) %>
<meta charset="UTF-8">
<div id="modal" onclick="cerrarModal()" class="relative z-10" style="display: none;">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Descargar CSV</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">Descargar versiones del historial en csv.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button id="indescargarhistorial" class="inline-flex w-full justify-center rounded-md bg-blue-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">
                        Descargar todo el historial
                    </button>
                    <button onclick="location.href = 'historial';" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>

            </div>
        </div>
    </div>
</div>


<input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>">
<div class="p-4 sm:ml-20 sm:mr-10 font-sans">

  <div class="shadow-lg flex flex-col justify-right p-4 border-2 border-gray-200 rounded-lg dark:border-gray-700 bg-slate-200">
        <div class="inline-flex justify-between items-center">
            <span style='font-size:30px;'>&#128214; Historial</span>
            <div class="flex space-x-2">
                <button id="descargarhistorial" onclick="descargarhist()" class="bg-white hover:bg-indigo-600 hover:text-white py-2 px-4 rounded-full flex items-center">
                    <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M2.83331 2.33335C2.37308 2.33335 1.99998 2.70645 1.99998 3.16669V14.8334C1.99998 15.2936 2.37308 15.6667 2.83331 15.6667H11.1666C11.6269 15.6667 12 15.2936 12 14.8334L12 6.8452L7.48814 2.33335H2.83331ZM0.333313 3.16669C0.333313 1.78598 1.4526 0.666687 2.83331 0.666687H7.48814C7.93016 0.666687 8.35409 0.842282 8.66665 1.15484L13.1785 5.66669C13.4911 5.97925 13.6666 6.40317 13.6666 6.8452V14.8334C13.6666 16.2141 12.5474 17.3334 11.1666 17.3334H2.83331C1.4526 17.3334 0.333313 16.2141 0.333313 14.8334V3.16669ZM6.99998 6.50002C7.46022 6.50002 7.83331 6.87312 7.83331 7.33335V10.3215L8.91072 9.2441C9.23616 8.91866 9.7638 8.91866 10.0892 9.2441C10.4147 9.56954 10.4147 10.0972 10.0892 10.4226L7.58923 12.9226C7.2638 13.248 6.73616 13.248 6.41072 12.9226L3.91072 10.4226C3.58529 10.0972 3.58529 9.56954 3.91072 9.2441C4.23616 8.91866 4.7638 8.91866 5.08923 9.2441L6.16665 10.3215V7.33335C6.16665 6.87312 6.53974 6.50002 6.99998 6.50002Z" fill="#4A5567"/>
                    </svg>
                    Descargar Historial
                    <% if (FileTypeError) { %>
                        <script>
                            swal('Error', 'Debes subir archivos de tipo csv.', 'info');
                        </script>
                    <% } %>
                    <% if (Succes) { %>
                        <script>
                            swal('Guardado', 'La versión se ha registrado.', 'success')
                        </script>
                    <% } %>
                    <% if (FormatTypeError) { %>
                        <script>
                            swal('Atención.', 'Revisa el formato de tu archivo CSV.', 'info')
                        </script>
                    <% } %>
                </button>
                <button id="openModalButton"  class="bg-white hover:bg-indigo-600 hover:text-white py-2 px-4 rounded-full flex items-center">
                    <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M2.83331 2.33335C2.37308 2.33335 1.99998 2.70645 1.99998 3.16669V14.8334C1.99998 15.2936 2.37308 15.6667 2.83331 15.6667H11.1666C11.6269 15.6667 12 15.2936 12 14.8334L12 6.8452L7.48814 2.33335H2.83331ZM0.333313 3.16669C0.333313 1.78598 1.4526 0.666687 2.83331 0.666687H7.48814C7.93016 0.666687 8.35409 0.842282 8.66665 1.15484L13.1785 5.66669C13.4911 5.97925 13.6666 6.40317 13.6666 6.8452V14.8334C13.6666 16.2141 12.5474 17.3334 11.1666 17.3334H2.83331C1.4526 17.3334 0.333313 16.2141 0.333313 14.8334V3.16669ZM6.99998 6.50002C7.46022 6.50002 7.83331 6.87312 7.83331 7.33335V10.3215L8.91072 9.2441C9.23616 8.91866 9.7638 8.91866 10.0892 9.2441C10.4147 9.56954 10.4147 10.0972 10.0892 10.4226L7.58923 12.9226C7.2638 13.248 6.73616 13.248 6.41072 12.9226L3.91072 10.4226C3.58529 10.0972 3.58529 9.56954 3.91072 9.2441C4.23616 8.91866 4.7638 8.91866 5.08923 9.2441L6.16665 10.3215V7.33335C6.16665 6.87312 6.53974 6.50002 6.99998 6.50002Z" fill="#4A5567"/>
                    </svg>
                    Importar Leads
                </button>
            </div>
        </div>
        <div class="flex justify-center sm:mt-4 p-1 border-1 border-gray-200 rounded-lg dark:border-gray-200 bg-white">
            <% if(versiones.length === 0) {%>
                <p class="text-2xl text-gray-500 mt-48 mb-48">Importa tus primeros leads, para poder visualizar el historial.</p>
            <%  } else{ %> 
            
                <div class="container flex flex-col items-center h-full">

                    <div class="container">
                        <table class="text-sm text-left text-gray-500 dark:text-gray-400 w-full">
                            <thead class=" flex w-full text-xs text-gray-700 uppercase bg-gray-100 dark:text-gray-500">
                                <tr class="flex w-full">
                                    <th class="p-4 w-1/4">Versión</th>
                                    <th class="p-4 w-1/4">Número de versión</th>
                                    <th class="p-4 w-1/4">Creador</th>
                                    <th class="p-4 w-1/4">Fecha de importación</th>
                                </tr>
                            </thead>
                        <!-- Remove the nasty inline CSS fixed height on production and replace it with a CSS class — this is just for demonstration purposes! -->
                        <% if (versiones.length<5){%>
                            <tbody class="bg-grey-light flex flex-col items-center justify-between  w-full">
                                <% let row=0; for (let version of versiones) { %>
                                    <% if(row%2==0){%>
                                        <tr class="flex w-full mb-4">
                                    <% } else {%>
                                        <tr class="flex w-full mb-4 bg-gray-50">
                                    <% } %>
                                        <td class="p-4 w-1/4">
                                            <%= version.NombreVersion %>
                                        </td>
                                        <td class="p-4 w-1/4">
                                            <%= version.IDVersion %>
                                        </td>
                                        <td class="p-4 w-1/4">
                                            <%= version.IDUsuario %>
                                        </td>
                                        <td class="p-4 w-1/4">
                                            <%  let fechaActual = version.FechaCreacion;
                                                // Convertir la fecha a un objeto Date
                                                const fecha = new Date(fechaActual);
                                                // Obtener día, mes y año
                                                const dia = fecha.getDate().toString().padStart(2, '0');
                                                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0'); // El mes comienza desde 0
                                                const año = fecha.getFullYear();
                                                // Crear la cadena en el formato deseado (dd/mm/yyyy)
                                                const fechaFormateada = `${dia}/${mes}/${año}`;%>
                                            <%= fechaFormateada %>
                                        </td>
                                    </tr>
                                    <% row++ } %>
                            </tbody>
                        </table>
                        <% } else  {%>    
                        <tbody class="bg-grey-light flex flex-col items-center justify-between overflow-y-scroll w-full" style="height: 65vh;">
                            <% let row=0; for (let version of versiones.reverse()) { %>
                                <% if(row%2==0){%>
                                    <tr class="flex w-full mb-4">
                                <% } else {%>
                                    <tr class="flex w-full mb-4 bg-gray-50">
                                <% } %>
                                    <td class="p-4 w-1/4">
                                        <%= version.NombreVersion %>
                                    </td>
                                    <td class="p-4 w-1/4">
                                        <%= version.IDVersion %>
                                    </td>
                                    <td class="p-4 w-1/4">
                                        <%= version.IDUsuario %>
                                    </td>
                                    <td class="p-4 w-1/4">
                                        <%  let fechaActual = version.FechaCreacion;
                                            // Convertir la fecha a un objeto Date
                                            const fecha = new Date(fechaActual);
                                            // Obtener día, mes y año
                                            const dia = fecha.getDate().toString().padStart(2, '0');
                                            const mes = (fecha.getMonth() + 1).toString().padStart(2, '0'); // El mes comienza desde 0
                                            const año = fecha.getFullYear();
                                            // Crear la cadena en el formato deseado (dd/mm/yyyy)
                                            const fechaFormateada = `${dia}/${mes}/${año}`;%>
                                        <%= fechaFormateada %>
                                    </td>
                                </tr>
                                <% row++ } %>
                        </tbody>
                        </table>
                        <% }%>

                    </div>
                </div>
            
            <% } %> 
        </div>      
</div>


  <script>

    function mostrarCarga() {
        Swal.fire({
            title: 'Cargando leads a la plataforma...',
            allowEscapeKey: false,
            allowOutsideClick: false,
            showConfirmButton: false,
            onOpen: () => {
                Swal.showLoading(); // Mostrar la animación de carga
            }
        });
    }

    const openModalButton = document.getElementById('openModalButton');
openModalButton.addEventListener('click', function() {
  const modalContent = `
    <div class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mr-6 mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                <h2 class="text-center font-semibold leading-6 text-xl text-gray-900" id="modal-title">Importar Leads</h2>
                                <div class="mt-2">
                                    <p class="text-black-600">
                                        

                                        <br>Para asegurar que la importación de tus lead sea exitosa, tu archivo debe contener:

                                        

                                        <ul class="ml-10 mt-2 mb-2 mr-8 list-disc">
                                            <li>El Télefono sin el símbolo de "+".</li>
                                            <li>Las columnas en este orden: Teléfono, 
                                                Nombre de contacto, Valor monetario,
                                                Email, Etiquetas (separadas por comas), Asignado.</li>
                                            <li>Todos los números de tus leads <b>deben ser de un solo país.</b></li>
                                        </ul>

                                        Puedes ayudarte a limpiar tu archivo con nuestro vídeo tutorial
                                        <u><a class="text-indigo-600" href="https://youtu.be/yHprcxsh78c">ver aquí</a></u>.
 

                                    <br>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form action="/lead/Historial" method="POST" enctype="multipart/form-data" id="uploadForm">
                        <label for="text" class="mt-4 mb-4 ml-10 block text-sm font-medium text-gray-900 dark:text-white">Nombre de la versión:</label>
                                               
                        <div class="flex">   
                            <input type="text" placeholder="Ingrese el nombre de la versión" id="versionName" name="versionName" class="ml-10 w-5/6 bg-gray-50 appearance-none border-2 border-gray-300 rounded py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500" required />
                            <span class="w-1/6"></span>
                        </div>
                        <input class="mt-8 ml-4 mb-4 inline-flex w-full justify-center  sm:flex sm:flex-row-reverse sm:px-6" type="file" id="csv" name="csv">
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                            <button type="submit" id="submitButton" class="inline-flex w-full justify-center rounded-md bg-blue-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-600 sm:ml-3 sm:w-auto" onclick="mostrarCarga()" disabled>Subir</button>
                            <button onclick="location.href = 'historial';" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>`;

  document.body.insertAdjacentHTML('beforeend', modalContent);

  // Obtener referencia a los elementos de entrada y al botón de envío
  const versionNameInput = document.getElementById('versionName');
  const csvInput = document.getElementById('csv');
  const submitButton = document.getElementById('submitButton');

  // Función para verificar si todos los campos están completos
  function verificarCamposCompletos() {
      return versionNameInput.value.trim() !== '' && csvInput.files.length > 0;
  }

  // Función para habilitar o deshabilitar el botón de envío según el estado de los campos
  function actualizarEstadoBoton() {
      if (verificarCamposCompletos()) {
          submitButton.removeAttribute('disabled');
      } else {
          submitButton.setAttribute('disabled', 'disabled');
      }
  }

  // Escuchar los eventos de entrada en los campos
  versionNameInput.addEventListener('input', actualizarEstadoBoton);
  csvInput.addEventListener('change', actualizarEstadoBoton);
});

function descargarhist() {
    console.log('descargarh');
    
        $('#modal').show();
    
    document.getElementById('indescargarhistorial').addEventListener('click', indescargarhistorial);
}

function cerrarModal() {
    $('#modal').hide();
}
function indescargarhistorial() {
    console.log('indescargarhistorial');
    var versiones = [];
    var filas = document.querySelectorAll('tbody tr');

    filas.forEach(function(fila) {
        var version = {
            NombreVersion: fila.children[0].innerText,
            IDVersion: fila.children[1].innerText,
            IDUsuario: fila.children[2].innerText,
            FechaCreacion: fila.children[3].innerText
        };

        versiones.push(version);
    });

    fetch('/lead/descargarhistorial', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(versiones)
    }).then(response => {
        response.blob().then(blob => {
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'historial.pdf';
            a.click();
        });
    });
}



function descargarhist() {
    console.log('descargarh');
    
        $('#modal').show();
    
    document.getElementById('indescargarhistorial').addEventListener('click', indescargarhistorial);
}

function cerrarModal() {
    $('#modal').hide();
}
function indescargarhistorial() {
    console.log('indescargarhistorial');
    var versiones = [];
    var filas = document.querySelectorAll('tbody tr');

    filas.forEach(function(fila) {
        var version = {
            NombreVersion: fila.children[0].innerText,
            IDVersion: fila.children[1].innerText,
            IDUsuario: fila.children[2].innerText,
            FechaCreacion: fila.children[3].innerText
        };

        versiones.push(version);
    });

    fetch('/lead/descargarhistorial', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(versiones)
    }).then(response => {
        response.blob().then(blob => {
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'historial.pdf';
            a.click();
        });
    });
}

</script>