<%- include('includes/head.ejs', {username: username})%>
<div class="p-4 sm:ml-20 sm:mr-10 font-sans">
    <div class="shadow-lg flex flex-col justify-right p-4 border-2 border-gray-200 rounded-lg dark:border-gray-700 bg-slate-200">
        <div class="inline-flex justify-between items-center mb-4 mr-4">
            <span style='font-size:30px;'>游늵 Anal칤ticas</span>
                <div class="flex space-x-2 items-center ">
                    <p class="text-lg"><b>Visualizando datos de la version:</b></p>
                    <% %>
                    <select class="border text-lg border-grey-100 bg-grey-600 px-4 py-2 rounded-full shadow-sm focus:outline-none text-ellipsis">
                        <% for (let nombreDeVersion of nombreDeVersiones) { %>
                            <option value="1"><%= nombreDeVersion.NombreVersion %></option>
                        <% } %>
                    </select>
                <button id="openModalButton"  class="bg-white hover:bg-indigo-600 hover:text-white py-2 px-4 rounded-full flex items-center">
                    <svg width="14" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M2.83331 2.33335C2.37308 2.33335 1.99998 2.70645 1.99998 3.16669V14.8334C1.99998 15.2936 2.37308 15.6667 2.83331 15.6667H11.1666C11.6269 15.6667 12 15.2936 12 14.8334L12 6.8452L7.48814 2.33335H2.83331ZM0.333313 3.16669C0.333313 1.78598 1.4526 0.666687 2.83331 0.666687H7.48814C7.93016 0.666687 8.35409 0.842282 8.66665 1.15484L13.1785 5.66669C13.4911 5.97925 13.6666 6.40317 13.6666 6.8452V14.8334C13.6666 16.2141 12.5474 17.3334 11.1666 17.3334H2.83331C1.4526 17.3334 0.333313 16.2141 0.333313 14.8334V3.16669ZM6.99998 6.50002C7.46022 6.50002 7.83331 6.87312 7.83331 7.33335V10.3215L8.91072 9.2441C9.23616 8.91866 9.7638 8.91866 10.0892 9.2441C10.4147 9.56954 10.4147 10.0972 10.0892 10.4226L7.58923 12.9226C7.2638 13.248 6.73616 13.248 6.41072 12.9226L3.91072 10.4226C3.58529 10.0972 3.58529 9.56954 3.91072 9.2441C4.23616 8.91866 4.7638 8.91866 5.08923 9.2441L6.16665 10.3215V7.33335C6.16665 6.87312 6.53974 6.50002 6.99998 6.50002Z" fill="#4A5567"/>
                    </svg>
                    Descargar reporte
                </button>
            </div>
        </div>
            <div class="flex h-full text-center">
                <div class="w-1/2 mr-4 rounded-xl bg-white">
                    <p class="text-2xl mb-2 mt-4"><b>Total de Leads</b></p>
                    <div class="flex justify-end mr-10 mb-4">
                    <p class="mr-4 text-sm">Elige el per칤odo de an치lisis: </p>
                    <select id="dateRange" class=" border border-grey-100 text-sm bg-grey-600 rounded-md shadow-sm focus:outline-none text-ellipsis">
                        <option value="1">칔ltima semana</option>
                        <option value="2">칔ltimo mes</option>
                        <option value="3">칔ltimos 6 meses</option>
                        <option value="4">칔ltimo a침o</option>
                    </select>
                    </div>
                    <canvas id="leadsChart" class="ml-8 mr-8 mb-4"></canvas>
                </div>
                <div class="w-1/2 rounded-xl mr-4 bg-white">
                    <p class="text-2xl mb-2 mt-4"><b>Total de Leads por Agente</b></p>
                    <div class="flex justify-end mr-10 mb-4">
                    <p class="mr-4 text-sm">Elige el per칤odo de an치lisis: </p>
                    <select id="dateRangeLeadsPorAgente" class="border border-grey-100 text-sm bg-grey-600 rounded-md shadow-sm focus:outline-none text-ellipsis">
                        <option value="1">칔ltima semana</option>
                        <option value="2">칔ltimo mes</option>
                        <option value="3">칔ltimos 6 meses</option>
                        <option value="4">칔ltimo a침o</option>
                    </select>
                    </div>
                    <canvas id="leadsPorAgenteChart" class="ml-8 mr-8 mb-4"></canvas>
                    <div class="ml-8 mr-8 mb-4 text-sm">
                        <span id="totalLeadsPorAgente"></span>
                    </div>
                </div>
            </div>
            <div class="flex mt-4 text-center">
                <div class="flex flex-col w-1/3 mr-4 mb-4 bg-white rounded-xl justify-center items-center">
                    <p class="text-2xl h-full mb-4 mt-4"><b>Distribuci칩n de embudos</b></p>  
                    <div class="flex mb-4 rounded-xl h-full w-full justify-center items-center">
                        <canvas id="pieChartEmbudo"></canvas>
                    </div>
                </div>
                <div class="justify-center w-1/3 rounded-xl mr-4 bg-white">
                    <h2 class="text-2xl mb-4">Total de Leads: <span id="totalLeads" class="font-bold"><%= cantidadTotalLeads %></span></h2>
                    <h2 class="text-2xl mb-4">El <span id="porcentajeLeadsOrganicos"></span> de los leads son org치nicos.</h2>
                </div>
                <div class="w-1/3 rounded-xl mr-4 bg-white">  
                    <p class="text-2xl mb-2 mt-4"><b>........</b></p> 
                </div>
            </div>
            </div>
        </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>

    // Obtener la cantidad total de leads y la cantidad de leads org치nicos de los elementos HTML
    const cantidadTotalLeads = Number(document.getElementById('totalLeads').textContent);
    const cantidadLeadsOrganicos = <%- JSON.stringify(cantidadLeadsOrganicos) %>;

    // Funci칩n para obtener el color en funci칩n del porcentaje
    function getColorForPercentage(porcentaje) {
        if (porcentaje >= 75) {
            return 'text-blue-700';
        } else if (porcentaje >= 50) {
            return 'text-blue-500';
        } else if (porcentaje >= 25) {
            return 'text-blue-300';
        } else {
            return 'text-blue-100';
        }
    }

    // Calcular el porcentaje de leads org치nicos y actualizar el texto
    const porcentajeLeadsOrganicos = (cantidadLeadsOrganicos / cantidadTotalLeads) * 100;
    const porcentajeLeadsOrganicosElement = document.getElementById('porcentajeLeadsOrganicos');
    porcentajeLeadsOrganicosElement.textContent = porcentajeLeadsOrganicos.toFixed(2) + '%';

    // Asignar una clase de color en funci칩n del porcentaje
    porcentajeLeadsOrganicosElement.className = getColorForPercentage(porcentajeLeadsOrganicos);
    porcentajeLeadsOrganicosElement.style.fontWeight = 'bold';

    // Establecer la opci칩n seleccionada tan pronto como se carga el script
    const selectedRange = localStorage.getItem('selectedRange') || '1'; // Obtener el rango seleccionado
    if (selectedRange) {
        document.getElementById('dateRange').value = selectedRange; // Establecer la opci칩n seleccionada
    }

    // Establecer la opci칩n seleccionada de Agente
    const selectedRangeAgente = localStorage.getItem('selectedRangeAgente') || '1'; // Obtener el rango seleccionado
    if (selectedRangeAgente) {
        document.getElementById('dateRangeLeadsPorAgente').value = selectedRangeAgente; // Establecer la opci칩n seleccionada
    }

    // Datos de ejemplo para la gr치fica de donut
    const datos = <%- JSON.stringify(cantidadLeadsEmbudos) %>[0];

    // Crear arrays para almacenar las etiquetas y los totales de leads
    const embudos = [];
    const totalesLeads = [];

    // Iterar sobre cada objeto en el array
    datos.forEach(embudo => {
        // Obtener el nombre del embudo y el total de leads
        const nombreEmbudo = embudo.Embudo;
        const totalLeads = parseInt(embudo.TotalLeads);
        
        // Agregar el nombre del embudo y el total de leads a los arrays correspondientes
        embudos.push(nombreEmbudo);
        totalesLeads.push(totalLeads);
    });

    // Funci칩n para generar un color aleatorio pastel
    function getRandomPastelColor() {
        let r, g, b;
        do {
            r = Math.floor(Math.random() * 128) + 128; // Valor entre 128 y 255 para tonos m치s claros
            g = Math.floor(Math.random() * 128) + 128; // Valor entre 128 y 255 para tonos m치s claros
            b = Math.floor(Math.random() * 128) + 128; // Valor entre 128 y 255 para tonos m치s claros
        } while (r === g && g === b); // Evitar colores grises
        return `rgb(${r}, ${g}, ${b})`;
    }

    // Crear un array para almacenar los colores
    const backgroundColors = embudos.map(() => getRandomPastelColor());

    // Definir el objeto pieData con las etiquetas y los totales de leads
    const pieData = {
        labels: embudos, // Usar los nombres de los embudos como etiquetas
        datasets: [{
            label: '1',
            data:  totalesLeads,
            backgroundColor: backgroundColors,
            hoverOffset: 4
        }]
    };

    // Obtener el contexto del canvas para la gr치fica de donut
    const pieCtx = document.getElementById('pieChartEmbudo').getContext('2d');

    // Configuraci칩n de la gr치fica de donut
    let pieChartEmbudo = new Chart(pieCtx, {
        type: 'doughnut',
        data: pieData,
        options: {
            responsive: true,
            plugins: {
                datalabels: {
                    formatter: (value, ctx) => {
                        const total = ctx.chart.data.datasets[0].data.reduce((acc, curr) => acc + curr, 0);
                        const percentage = ((value / total) * 100).toFixed(2) + '%';
                        return percentage;
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                }
            },
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Gr치fica de Pay Embudo'
            }
        }
    });


    
    // Obtener el contexto del canvas para despu칠s crear la gr치fica
    const ctx = document.getElementById('leadsChart').getContext('2d');

    // Funci칩n para formatear la fecha
    function formatDate(date, range) {
        switch (parseInt(range)) {
            case 1: // Semana
                return moment(date).format('D'); // Solo el d칤a del mes
            case 2: // Mes
                return moment(date).format('D'); // Solo el d칤a del mes
            case 3: // Semestre
                return moment(date).format('MMM'); // Solo el mes
            case 4: // A침o
                return moment(date).format('MMM'); // Solo el mes
            default:
                throw new Error('Invalid range');
        }
    }

    // Funci칩n para obtener el texto del label
    function getLabelText(range) {
        switch (parseInt(range)) {
            case 1: // Semana
            case 2: // Mes
                return 'Leads por d칤a';
            case 3: // Semestre
            case 4: // A침o
                return 'Leads por mes';
            default:
                throw new Error('Invalid range');
        }
    }


    // Datos de ejemplo
    const leadsPerDay = <%- JSON.stringify(leadsPerDay) %>.map(item => ({
        ...item,
        Fecha: new Date(item.Fecha)
    }));

    console.log("LEADSPERDAY",leadsPerDay);
    
    let myChart = new Chart(ctx, {
    type: 'line',
    data: {
            labels: leadsPerDay.map(lead => formatDate(lead.Fecha, selectedRange)), // Usar leadsPerDay para las etiquetas
            datasets: [{
                label: getLabelText(selectedRange), // Usar la funci칩n getLabelText
                data: leadsPerDay.map(lead => lead.CantidadLeads), // Mapear leadsPerDay a un array de cantidades de leads
                backgroundColor: 'rgba(23, 16, 198, 0.2)',
                pointStyle: 'circle', // Cambiar la forma de los puntos a tri치ngulos
                borderColor: 'rgba(23, 16, 198, 0.8)',
                borderWidth: 5,
                pointRadius: 5,
                pointBackgroundColor: 'rgba(23, 16, 198, 0.8)',
                tension: 0.5,
                fill: true,
                point: {
                    onHover: (event, point, dataset, context) => {
                        event.native.target.style.cursor = 'pointer';
                    },
                    onLeave: (event, point, dataset, context) => {
                        event.native.target.style.cursor = 'default';
                    }
                }   
            }]
        },

        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        drawOnChartArea: false
                    }
                },
                x: {
                    grid: {
                        drawBorder: false,
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    intersect: false,
                    mode: 'index',
                    displayColors: false,
                    callbacks: {
                        title: function(tooltipItem) {
                            return getLabelText(selectedRange); // Usar la funci칩n getLabelText
                        },
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('es-ES').format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'custom_grid_lines',
            beforeDraw: (chart, args, options) => {
                const {ctx, scales} = chart;
                const {x: xAxis} = scales;
                ctx.save();
                xAxis.ticks.forEach((value, index) => {
                    if (index === 0) return;
                    const xPos = xAxis.getPixelForTick(index);
                    ctx.setLineDash([4, 4]);
                    ctx.beginPath();    
                    ctx.moveTo(xPos, scales.y.top);
                    ctx.lineTo(xPos, scales.y.bottom);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                    ctx.stroke();
                });
                ctx.restore();
            }
        }]
    });
 

    var fechas = <%- JSON.stringify(fechas) %>;
    var datasets = <%- JSON.stringify(datasets) %>;

    // Calcular el total de Leads por Agente
    const totalLeadsPorAgente = datasets.map(dataset => {
        const totalLeads = dataset.datos.reduce((a, b) => a + b, 0);
        return `${dataset.agente}: ${totalLeads}`;
    });

    // Actualizar el contenido del elemento HTML con el total de Leads por Agente
    document.getElementById('totalLeadsPorAgente').textContent = totalLeadsPorAgente.join(', ');
   
    // Formatear las fechas antes de usarlas en la gr치fica
   

    // Obtener el contexto del segundo canvas
    const ctxAgent = document.getElementById('leadsPorAgenteChart').getContext('2d');

     // Crear la gr치fica de Leads por Agente
     const leadsPorAgenteChart = new Chart(ctxAgent, {
        type: 'line',
        data: {
        labels: fechas.map(fecha => formatDate(fecha, selectedRangeAgente)), // Usar la funci칩n formatDate
        datasets: datasets.map(dataset => ({
            label: dataset.agente, // Asegurarse de incluir la propiedad label
            data: dataset.datos, // Asegurarse de incluir la propiedad data
            tension: 0.4 // A침adir curvas a las l칤neas
        }))
    },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        drawOnChartArea: false
                    },
                    title: {
                        display: true,
                        text: 'Leads'
                    }
                },
                x: {
                    grid: {
                        drawBorder: false,
                        drawOnChartArea: false
                    },
                    title: {
                        display: true,
                        text: 'Perido de tiempo'
                    }
                }
            },
            plugins: {
                tooltip: {
                    intersect: false,
                    mode: 'index',
                    displayColors: false,
                    callbacks: {
                        title: function(tooltipItem) {
                            return getLabelText(selectedRange); // Actualizar el t칤tulo del tooltip
                        }
                    }
                }
            }
        }
    });

    

    document.getElementById('dateRangeLeadsPorAgente').addEventListener('change', function(event) {
    event.preventDefault(); // Evitar la recarga de la p치gina
    const selectedRangeAgent = this.value;
    localStorage.setItem('selectedRangeAgent', selectedRangeAgent); // Guardar el rango seleccionado

    fetch('/lead/analitics/agent/' + selectedRangeAgent)
    .then(response => response.json())
    .then(data => {
        console.log("CHECARESTO",data);

        // Utilizar los datos ya procesados que recibes del servidor
        const fechas = data.fechas;
        const datasets = data.datasets.map(dataset=> {
            return {
                label: dataset.agente, // Usar el nombre del agente
                data: dataset.datos, // Usar los datos del agente
                tension: 0.4 // A침adir curvas a las l칤neas
            };
        });

            // Calcular el total de Leads por Agente
            const totalLeadsPorAgente = datasets.map(dataset => {
            const totalLeads = dataset.data.reduce((a, b) => a + b, 0);
            return `${dataset.label}: ${totalLeads}`;
        });

        // Actualizar el contenido del elemento HTML con el total de Leads por Agente
        document.getElementById('totalLeadsPorAgente').textContent = totalLeadsPorAgente.join(', ');

        // Actualizar la gr치fica con los nuevos datos
        leadsPorAgenteChart.data.labels = fechas.map(fecha => formatDate(fecha, selectedRangeAgent));
        leadsPorAgenteChart.data.datasets = datasets;
        leadsPorAgenteChart.update();
    })
    .catch(error => console.error('Error en la solicitud fetch: ', error));
});

// -----------  CAMBIO DE RANGO DE LEADS POR D칈A  ------------------ 

    document.getElementById('dateRange').addEventListener('change', function(event) {
    event.preventDefault(); // Evitar la recarga de la p치gina
    const selectedRange = this.value;
    localStorage.setItem('selectedRange', selectedRange); // Guardar el rango seleccionado

    // Hacer una solicitud AJAX para obtener los datos
    fetch('/lead/analitics/' + selectedRange)
    .then(response => response.json())
    .then(data => {
        // Formatear las fechas y actualizar la gr치fica con los nuevos datos
        myChart.data.labels = data.leadsPerDay.map(lead => formatDate(lead.Fecha, selectedRange));
        myChart.data.datasets[0].data = data.leadsPerDay.map(lead => lead.CantidadLeads);
        myChart.data.datasets[0].label = getLabelText(selectedRange); // Actualizar el label del dataset
        myChart.options.plugins.tooltip.callbacks.title = function(tooltipItem) {
            return getLabelText(selectedRange); // Actualizar el t칤tulo del tooltip 
        };
        myChart.update();
    })
    .catch(error => console.error('Error en la solicitud fetch: ', error));
});
</script>